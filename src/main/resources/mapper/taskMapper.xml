<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/schema/mybatis-3-mapper.dtd">
<mapper namespace="me.jhchoi.ontrack.mapper.TaskMapper" >

    <insert id="newTask" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO ontrack_task(project_id, task_title, AUTHOR, task_priority, task_status, task_dueDate, task_parent_id, createdAt, updatedAt, updatedBy)
        VALUES (#{projectId}, #{taskTitle}, #{author}, #{taskPriority}, #{taskStatus}, #{taskDueDate}, #{taskParentId}, #{createdAt}, #{updatedAt}, #{updatedBy})
    </insert>

    <insert id="assign" parameterType="java.util.List" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO task_assignment(project_id, task_id, member_id, nickname, role, assignedAt)
        VALUES
        <foreach collection="list" item="ta" separator=",">
            (#{ta.projectId}, #{ta.taskId}, #{ta.memberId}, #{ta.nickname}, #{ta.role}, #{ta.assignedAt})
        </foreach>
    </insert>

    <insert id="log" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO task_history(project_id, task_id, modItem, modType, modContent, updatedAt, updatedBy)
        VALUES (#{projectId}, #{taskId}, #{modItem}, #{modType}, #{modContent}, #{updatedAt}, #{updatedBy})
    </insert>

    <select id="findById" resultType="OnTrackTask">
        SELECT task_title, AUTHOR, task_status, createdAt
        FROM ontrack_task
        WHERE id = #{id}
    </select>

    <select id="getAssigneeList" resultType="TaskAssignment">
        SELECT task_id, nickname, member_id
        FROM task_assignment
        WHERE task_id = #{taskId}
    </select>

</mapper>